## listeners

### 网络过滤器：`networkFilter`

#### 验证授权过滤器：`ExtAuthz`

``` yaml
filters:
  - name: envoy.filters.network.ext_authz
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.ext_authz.v3.ExtAuthz
      stat_prefix: ext_authz	# 记录日志时的前缀
      grpc_service:
        envoy_grpc:
          cluster_name: ext-authz # gRPC 验证服务器集群
      include_peer_certificate: true # 为true 将会把对等证书发送给验证服务器
```

`gRPC服务器实现`

``` csharp
public class AuthService : Envoy.Service.Auth.V3.Authorization.AuthorizationBase
{
    public override Task<CheckResponse> Check(CheckRequest request, ServerCallContext context)
    {
        return Task.FromResult(new CheckResponse { Status = new Google.Rpc.Status { Code = 401, Message = "错误！" } });
        // 返回内容中Status的Code不为200则代表失败
    }
}
```

#### 本地限速：`local_ratelimit`

每个链接访问过来，Envoy会给该链接自动颁发令牌

概述：为了限制在`多长时间`内可以接受`多少链接`

``` yaml
filters:
  - name: envoy.filters.network.ext_authz
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.filters.network.ext_authz.v3.ExtAuthz
      stat_prefix: "本地限速" # 记录日志时的前缀
      TokenBucket: # 令牌桶
        MaxTokens: 1 # 桶里的令牌最多能有几个
        FillInterval:
          Seconds: 2 # 隔几秒往桶里装令牌
```

## HTTP

### HTTP管理器：`HTTP connection manager`

#### HTTP协议

编解码器API用于将不同的有线协议转换为与流，请求，响应等无关的协议形式。在HTTP / 1.1的情况下，编解码器将协议的串行/流水线功能转换为类似于HTTP的形式/ 2到更高的层，这意味着大多数代码不需要了解流是起源于HTTP / 1.1，HTTP / 2还是HTTP / 3连接。

#### 路由表配置

每个HTTP连接管理器过滤器都有一个关联的路由表。可以通过以下两种方式之一指定路由表：

* 静态的
* 通过RDS API动态的

#### 路由匹配

Virtual Host(虚拟主机)

> HTTP请求的主机头或authority头与`Virtual Host`做匹配
>
> 按顺序检查虚拟主机中的每个`路由条目`，如果匹配则使用该路由
>
> 按顺序检查虚拟主机中的每个`虚拟集群`，如果存在匹配项，则使用该集群`记录日志`
>
> 注：`虚拟群集`的作用只是为了，针对某些重要端点指定正则表达式进行匹配，以便为匹配的请求显式生成`统计信息`

`Virtual Host`样例：

``` yaml
virtual_hosts: # 此处配置虚拟主机 用于转发请求
 - name: local_service
   domains: ["*"] # 任何的域 也就是所有的请求的都会进入这里
   routes:
   - match:
       prefix: "/" # 匹配前缀 为 / 的请求
     route:
       host_rewrite_literal: www.envoyproxy.io # 替换的主机头
       cluster: service_envoyproxy_io # 跳转到指定集群
```

#### 请求转移/分流

`转移`

> 让请求在多个上游(集群)之间来回横跳
>
> 通过使用*runtime_fraction* 配置，可以将到虚拟主机中特定路由的流量逐渐从一个群集转移到另一个群集

``` yaml
virtual_hosts:
  - name: test_shift
    domains: ["*"]
    routes:
      - match:
          prefix: "/"
          runtime_fraction:  # 转移配置
            default_value:	# 如果分子/分母键的运行时值不可用(应该指的是命令行设置的分子分母)，则为默认值
            #此处可以理解为该配置的百分比 100%为全部流进该路由 0为弃用该路由
              numerator: 50
              denominator: HUNDRED
            runtime_key: routing.traffic_shift.test # YAML表达式的运行时密钥
        route:
          host_rewrite_literal: www.baidu.com
          cluster: test_v1
      - match:
          prefix: "/"
        route:
          host_rewrite_literal: www.jd.com
          cluster: test_v2
```

`分流`

> 

## 扩展配置参考

Envoy中的每个配置资源在中都有一个URL类型`typed_config`

如果`@type`能够解释配置的扩展名，则无论该`name`字段是什么，都将选择该扩展名，在这种情况下，`name`字段变为可选字段，并且可以用作扩展配置的特定实例的标识符或注释。例如：

``` yaml
name: front-http-proxy
typed_config:
  "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
  stat_prefix: ingress_http
  ...
```

如果控制面板缺少指定资源类型，那么可以用`udpa.type.v1.TypedStruct`类型指定为通用容器，然后客户端将使用其中的`type_url`来转换为具体的资源类型，例如：

``` yaml
name: front-http-proxy
typed_config:
  "@type": type.googleapis.com/udpa.type.v1.TypedStruct
  type_url: type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
  value:
    stat_prefix: ingress_http
    ...
```